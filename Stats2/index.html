<!DOCTYPE html>
<html>
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    
        <title>Simply's IRL Stats v3</title>

        <style>
            .body {background-color: rgb(24, 26, 27); color: #EEE }
            .mainDiv {margin: 8px; box-sizing: border-box;}
            .text-box {background-color: #000000; color: #EEE; align-self: flex-start;}
            .spaced {margin-top:4px; margin-bottom:4px;}
            .padded {padding:8px;}
            .section {margin: 4px; padding: 4px 8px 4px 8px; background-color: rgb(43, 44, 42); border-radius: 8px;}
            .cmb-btn {color: #ffffff;}
            .cmb-btn:hover { border-color: red; }
            .gaming { background-color: #302381; border-color: #302381;}
            .hobby { background-color: #85200c; border-color: #85200c;}
            .work { background-color: #b45f06;}
            .social { background-color: #38761d;}
            .entertainment { background-color: #1155cc;}
            .life { background-color: #ffffff; color: #000000;}
            .other { background-color: #cc6cc0;}
            .activity.card { background-color: rgb(24, 26, 27); max-width: 18rem; max-height: 18rem; border-radius: 8px; margin: 8px;}
            .card-header:first-child { border-radius: 8px 8px 0 0;}
            .card-footer.full-flex { display: flex; padding: 0;}
            .half-flex-btn { flex: 50%; margin: -1px; border-radius: 0;}
            .half-flex-btn.left { border-bottom-left-radius: 8px;}
            .half-flex-btn.right { border-bottom-right-radius: 8px;}
            .section.card-deck { padding: 8px;}
            .center { text-align: center;}
        </style>
    </head>
    <body class="body">
        <div class="mainDiv">
            <a href="https://docs.google.com/spreadsheets/d/1XJf58kS6GEaggU-V-hWOlPc3q1Z8C81xrP-2Y2DLHOI/edit">Simply's Life Tracker</a><br>

            <!--Add buttons to initiate auth sequence and sign out-->
            <button type="button" class="spaced btn btn-primary" id="authorize_button" hidden="true">
                <span id="authorizeLoadIcon" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" hidden="true"></span>
                Authorize
            </button>
            <button type="button" class="spaced btn btn-primary" id="signout_button" hidden="true">Sign Out</button>
            <br>
            <div class="section">

                <div class="btn-group" data-toggle="buttons">
			
                    <label class="btn cmb-btn gaming active">
                        <input type="radio" name="activityCat" value="0" autocomplete="off" checked>
                        Gaming
                    </label>
        
                    <label class="btn cmb-btn hobby">
                        <input type="radio" name="activityCat" value="1" autocomplete="off">
                        Useful Hobby
                    </label>
        
                    <label class="btn cmb-btn work">
                        <input type="radio" name="activityCat" value="2" autocomplete="off">
                        Work
                    </label>
        
                    <label class="btn cmb-btn social">
                        <input type="radio" name="activityCat" value="3" autocomplete="off">
                        Social
                    </label>
        
                    <label class="btn cmb-btn entertainment">
                        <input type="radio" name="activityCat" value="4" autocomplete="off">
                        Entertainment
                    </label>
                
                    <label class="btn cmb-btn life">
                        <input type="radio" name="activityCat" value="5" autocomplete="off">
                        Life Necessity
                    </label>

                    <label class="btn cmb-btn other">
                        <input type="radio" name="activityCat" value="6" autocomplete="off">
                        Other
                    </label>

                </div>

                <p>Activity:</p>
                <input type="text" id="txt_activity_name" class="spaced container-fluid form-control text-box">
                <br>
                <p>Details:</p>
                <input type="text" id="txt_activity_details" class="spaced container-fluid form-control text-box">
                <br>
                <button type="button" class="spaced btn btn-success" id="btn_send_activity" onclick="sendActivityClick();">Send Activity</button>
            </div>
            <div id="activitiesDeck" class="section card-deck">
                <template id="activityCard">
                    <div class="activity card">
                        <div class="card-header hobby" style="margin: -1px;">
                            <h5 class="card-title">Example Activity</h5>
                            <h6 class="card-subtitle mb-2 text-muted">Category</h6>
                        </div>
                            <div class="card-body" style="display: flex;">
                            <div class="cotainer" style="flex:-moz-available;">
                                <div class="row">
                                    <div class="col-sm center">28/08/2020</div>
                                    <div class="col-sm center">28/08/2020</div>
                                </div>
                                <div class="row">
                                    <div class="col-sm center">02:00:00</div>
                                    <div class="col-sm center">04:00:00</div>
                                </div>
                                <div class="row center">
                                    <div class="col-sm center"><br>Time elapsed: 02:00:00</div>
                                </div>
                            </div>
                        </div>
                            <div class="card-footer full-flex">
                            <button type="button" class="btn btn-primary half-flex-btn left">Close Activity</button>
                            <button type="button" class="btn btn-danger half-flex-btn right">Cancel Activity</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </body>

    <script type="text/javascript">
        // Client ID and API key from the Developer Console
        var CLIENT_ID = '577967747026-57t00iia28et6vmgtj5jg8p4fe15i43e.apps.googleusercontent.com';
        var API_KEY = 'AIzaSyDQpiPLMDw-gv8kosUfKwxad4QNhAyBdS0';
        var SPREADSHEETID = '1XJf58kS6GEaggU-V-hWOlPc3q1Z8C81xrP-2Y2DLHOI';
        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/spreadsheets";

        var authorizeButton = document.getElementById('authorize_button');
        var signoutButton = document.getElementById('signout_button');
        var txtActivityName = document.getElementById('txt_activity_name');
        var txtActivityDetails = document.getElementById('txt_activity_details');
        var cmbActivityCategory = document.getElementById('cmb_activity_category');

        var cardDeck = document.getElementById('activitiesDeck');

        const TIMEDATAPAGE = "'Time allocation data'!";
        const CATEGORYRANGES = ["B{0}:E", "F{0}:I", "J{0}:M", "N{0}:Q", "R{0}:U", "V{0}:Y", "Z{0}:AC"];
        var lastUsedIX = [0, 0, 0, 0, 0, 0, 0];

        function sendActivity(name, details, categoryIX) {
            var range = getCategoryRange(categoryIX);

            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEETID,
                range: range,
            }).then(function(response) {

                var ix = response.result.values.length + 5;
                var resRange = response.result;
                if (resRange.values.length > 0) {
                    for (i = 0; i < resRange.values.length; i++) {
                        var row = resRange.values[i];
                        
                        if(row[0] == name && row[2] == undefined)
                            closeActivity(getCategoryRange(categoryIX, ix), row);
                    }
                }
                
                createActivity(getCategoryRange(categoryIX, ix), name);

            })
        }

        function closeActivity(range, row) {
            row[2] = getDateTimeString(offset);
            row[3] = actWaste;
            write(range, row)
        }

        function createActivity(range, name) {
            write(range, [name, "DATE", "", ""], 'Created activity: ' + name + ' from ' + "DATE");
        }

        function onReady() {
            fetchIXs();

            var inst = document.getElementsByTagName("template")[0];
            var clone = inst.content.cloneNode(true);
            cardDeck.appendChild(clone);
        }

        function fetchIXs() {
            var i = 0;
            for (i = 0; i < CATEGORYRANGES.length; i++) {
                fetchIX(i);
            }
        }

        function fetchIX(ix) {
            var newRange = getCategoryRange(ix);
                gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEETID,
                    range: newRange,
                }).then(function(response) {
                    lastUsedIX[ix] = response.result.values.length;
                });
        }

        function getCategoryRange(ix, row = -1) {
            if (row != -1)
                return TIMEDATAPAGE + CATEGORYRANGES[ix].replace("{0}", row.toString());
            
            // Since the first activity is in row 6 this actually goes 2 before the latest activity
            return TIMEDATAPAGE + CATEGORYRANGES[ix].replace("{0}", (lastUsedIX[ix] + 5).toString());
        }

        function write(newRange, values) {
            var params = {
                spreadsheetId: SPREADSHEETID,
                range: newRange,
                valueInputOption: 'USER_ENTERED',
            };

            var valueRangeBody = {
                "majorDimension": "ROWS",
                "range": newRange,
                "values": [values]
            };

            var request = gapi.client.sheets.spreadsheets.values.update(params, valueRangeBody);
            request.then(function(response) {
                console.log(response.result);
            }, function(reason) {
                console.error('error: ' + reason.result.error.message);
            });
	    }

        function getDateTimeString(offset = 0) {
            Date.prototype.ddmmyyyy = function() {
            var mm = this.getMonth() + 1; // getMonth() is zero-based
            var dd = this.getDate();
            return [(dd>9 ? '' : '0') + dd,
                    (mm>9 ? '' : '0') + mm,
                    this.getFullYear()
                    ].join('/');
            };
            
            Date.prototype.hhmmss = function() {
                var hh = this.getHours();
                var mm = this.getMinutes();
                var ss = this.getSeconds();
                
                return [(hh>9 ? '' : '0') + hh,
                    (mm>9 ? '' : '0') + mm,
                    (ss>9 ? '' : '0') + ss
                    ].join(':');
            };
            var date = new Date();
            var newDate = new Date(date.getTime() + offset*1000);
            return newDate.ddmmyyyy() + " " + newDate.hhmmss();
	    }

        // --------------------------------------------------------------------------------------

        function sendActivityClick() {
            var selectedCategoryIX = document.querySelector('input[name="activityCat"]:checked').value;
            sendActivity(txtActivityName.value, txtActivityDetails.value, selectedCategoryIX);
        }

        // --------------------------------------------------------------------------------------

        function handleClientLoad() {
		    gapi.load('client:auth2', initClient);
        }
    
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
                
                onReady();
            }, function(error) {
                //appendPre(JSON.stringify(error, null, 2), 'log');
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.hidden = true;
                signoutButton.hidden = false;
            } else {
                authorizeButton.hidden = false;
                document.getElementById("authorizeLoadIcon").hidden = true;
                signoutButton.hidden = true;
            }
        }
        
        function handleAuthClick(event) {
            document.getElementById("authorizeLoadIcon").hidden = false;
            gapi.auth2.getAuthInstance().signIn();
        }
        
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
</html>